name: Publish New Release

on:
  release:
    types: [published] # This triggers the workflow when a release is published

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write # Required for PyPI trusted publishing
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libdbus-glib-1-dev libdbus-1-dev libcairo2-dev libgirepository1.0-dev pkg-config debhelper devscripts dh-virtualenv dput python3-poetry-core python3-cairo python3-evdev

      - name: Install Poetry
        run: |
            pip install poetry
            poetry self add poetry-plugin-export

      - name: Install project dependencies
        run: poetry install --sync --no-interaction

      - name: Build package
        run: poetry build

      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          # The action automatically uses the OIDC token for authentication
          # and finds the built distribution files in the 'dist' directory
          repository-url: https://upload.pypi.org/legacy/ # Optional, defaults to PyPI

      - name: Build Virtual Environment
        run: |
          # Create the directory structure mimicking the target
          mkdir -p dist/usr/lib/nuxbt
          
          # Create venv in the temporary location
          python3 -m venv dist/usr/lib/nuxbt

          # Export requirements to ensure we get locked versions
          poetry export --without-hashes --format=requirements.txt > requirements.txt
          
          # Install the package and dependencies into the venv
          source dist/usr/lib/nuxbt/bin/activate
          # Install dependencies first from the locked requirements
          pip install -r requirements.txt
          # Then install the package itself
          pip install dist/*.whl
          
          # Fix shebangs to point to the target location /usr/lib/nuxbt
          # This ensures that when installed, they look for python in the right place
          sed -i 's|#!'"$PWD"'/dist/usr/lib/nuxbt|#!/usr/lib/nuxbt|g' dist/usr/lib/nuxbt/bin/*

      - name: Install NFPM
        run: |
          echo 'deb [trusted=yes] https://repo.goreleaser.com/apt/ /' | sudo tee /etc/apt/sources.list.d/goreleaser.list
          sudo apt-get update
          sudo apt-get install -y nfpm

      - name: Import GPG key
        id: import_gpg
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Build DEB and RPM packages
        env:
          GPG_KEY_ID: ${{ steps.import_gpg.outputs.keyid }}
        run: |
          export VERSION=${{ github.event.release.tag_name }}
          export VERSION=${VERSION#v}
          nfpm pkg --packager deb --target dist/nuxbt_${VERSION}_amd64.deb
          nfpm pkg --packager rpm --target dist/nuxbt-${VERSION}.x86_64.rpm

      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.event.release.tag_name }} dist/nuxbt_*.deb dist/nuxbt-*.rpm

      - name: Build and Upload to PPA
        env:
          GPG_KEY_ID: ${{ steps.import_gpg.outputs.keyid }}
          DEBEMAIL: "nuxbt@hannahis.gay"
          DEBFULLNAME: "NUXBT Releases"
        run: |
          export VERSION=${{ github.event.release.tag_name }}
          export VERSION=${VERSION#v}
          
          # Configure dput (using a simple config for Launchpad)
          echo "[my-ppa]" > ~/.dput.cf
          echo "fqdn = ppa.launchpad.net" >> ~/.dput.cf
          echo "method = ftp" >> ~/.dput.cf
          echo "incoming = ~hannahbee-0602/ubuntu/nuxbt/" >> ~/.dput.cf
          echo "login = anonymous" >> ~/.dput.cf
          echo "allow_unsigned_uploads = 0" >> ~/.dput.cf
          
          # Update changelog to match release version if needed
          # Ensure we have a clean state for the changelog
          # Update changelog to match release version if needed
          # Ensure we have a clean state for the changelog
          if ! grep -q "($VERSION-1)" debian/changelog; then
             dch -v "$VERSION-1" --distribution noble "New release $VERSION"
             
             # Extract changes from CHANGELOG.md and append them
             awk "/^## v$VERSION/{flag=1; next} /^## v/{flag=0} flag" CHANGELOG.md | sed '/^$/d' | sed 's/^[-*] //g' | while IFS= read -r line; do
                dch -a "$line"
             done

             # Commit the changelog change so it's included in the source
             git config --global user.email "bot@nuxbt.com"
             git config --global user.name "Nuxbt Bot"
             git commit -am "Update changelog for $VERSION [skip ci]"
          fi

           # Vendor dependencies and build source package using the script
           # This ensures consistency with local builds and uses poetry export
           ./scripts/build_ppa_source.sh
          
           # Upload to PPA
           dput my-ppa ../nuxbt_*_source.changes
